<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BloodDodo - Healthcare Blood Management Platform</title>
        <meta
            name="description"
            content="BloodDodo connects hospitals across Vietnam to life-saving blood donations. Real-time blood tracking, location mapping, and 24/7 availability for healthcare professionals."
        />
        <meta
            name="keywords"
            content="blood donation, healthcare, hospitals, Vietnam, blood bank, medical, blood tracking"
        />
        <meta name="author" content="BloodDodo" />

        <meta
            property="og:title"
            content="BloodDodo - Healthcare Blood Management Platform"
        />
        <meta
            property="og:description"
            content="Connecting hospitals across Vietnam to life-saving blood donations with real-time tracking and location mapping."
        />
        <meta property="og:type" content="website" />

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@blooddodo" />
        <link rel="stylesheet" href="/css/bloodRecords.css" />
        <link rel="stylesheet" href="/css/partials/footer.css" />
        <link rel="stylesheet" href="/css/partials/headerNav.css" />
        <!-- <script defer src="all.js"></script> -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Lobster+Two:ital,wght@0,400;0,700;1,400;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
            rel="stylesheet"
        />
    </head>

    <body>
        <nav class="navigation">
            <div class="nav-container">
                <div class="nav-content">
                    <!-- Logo and Brand -->
                    <%- include('partials/headerLogo') %>
                    <!-- Navigation Links -->
                    <%- include('partials/headerNav') %>
                </div>
            </div>
        </nav>
        <!-- Blood Records Page HTML -->
        <main class="blood-records-main">
            <div class="page-container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">Blood Records</h1>
                    <p class="page-description">
                        Search and filter available blood inventory across
                        healthcare facilities
                    </p>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <!-- Filters Section -->
                    <form method="GET" action="/page/bloodRecords" class="filters-container">
                        <h2 class="filters-title">Filter Results</h2>

                        <div class="filters-grid">
                            <!-- Blood Type Filter -->
                            <div class="filter-group">
                                <label class="filter-label">Blood Type</label>
                                <select name="bloodType" class="filter-select">
                                    <option value="">All Blood Types</option>
                                    <option value="A+" <%= filters?.bloodType==="A+" ? "selected" : "" %>>A+</option>
                                    <option value="A-" <%= filters?.bloodType==="A-" ? "selected" : "" %>>A-</option>
                                    <option value="B+" <%= filters?.bloodType==="B+" ? "selected" : "" %>>B+</option>
                                    <option value="B-" <%= filters?.bloodType==="B-" ? "selected" : "" %>>B-</option>
                                    <option value="AB+" <%= filters?.bloodType==="AB+" ? "selected" : "" %>>AB+</option>
                                    <option value="AB-" <%= filters?.bloodType==="AB-" ? "selected" : "" %>>AB-</option>
                                    <option value="O+" <%= filters?.bloodType==="O+" ? "selected" : "" %>>O+</option>
                                    <option value="O-" <%= filters?.bloodType==="O-" ? "selected" : "" %>>O-</option>
                                </select>
                            </div>

                            <!-- Location Filter -->
                            <div class="filter-group">
                                <label class="filter-label">Location</label>
                                <select name="location" class="filter-select">
                                    <option value="">All Locations</option>
                                    <option value="Hà Nội" <%= filters?.location==="Hà Nội" ? "selected" : "" %>>Hà Nội</option>
                                    <option value="Hồ Chí Minh" <%= filters?.location==="Hồ Chí Minh" ? "selected" : "" %>>Hồ Chí Minh</option>
                                    <option value="Đà Nẵng" <%= filters?.location==="Đà Nẵng" ? "selected" : "" %>>Đà Nẵng</option>
                                    <option value="Hải Phòng" <%= filters?.location==="Hải Phòng" ? "selected" : "" %>>Hải Phòng</option>
                                    <option value="Cần Thơ" <%= filters?.location==="Cần Thơ" ? "selected" : "" %>>Cần Thơ</option>
                                    <option value="An Giang" <%= filters?.location==="An Giang" ? "selected" : "" %>>An Giang</option>
                                    <option value="Bà Rịa - Vũng Tàu" <%= filters?.location==="Bà Rịa - Vũng Tàu" ? "selected" : "" %>>Bà Rịa - Vũng Tàu</option>
                                    <option value="Bắc Giang" <%= filters?.location==="Bắc Giang" ? "selected" : "" %>>Bắc Giang</option>
                                    <option value="Bắc Kạn" <%= filters?.location==="Bắc Kạn" ? "selected" : "" %>>Bắc Kạn</option>
                                    <option value="Bạc Liêu" <%= filters?.location==="Bạc Liêu" ? "selected" : "" %>>Bạc Liêu</option>
                                    <option value="Bắc Ninh" <%= filters?.location==="Bắc Ninh" ? "selected" : "" %>>Bắc Ninh</option>
                                    <option value="Bến Tre" <%= filters?.location==="Bến Tre" ? "selected" : "" %>>Bến Tre</option>
                                    <option value="Bình Định" <%= filters?.location==="Bình Định" ? "selected" : "" %>>Bình Định</option>
                                    <option value="Bình Dương" <%= filters?.location==="Bình Dương" ? "selected" : "" %>>Bình Dương</option>
                                    <option value="Bình Phước" <%= filters?.location==="Bình Phước" ? "selected" : "" %>>Bình Phước</option>
                                    <option value="Bình Thuận" <%= filters?.location==="Bình Thuận" ? "selected" : "" %>>Bình Thuận</option>
                                    <option value="Cà Mau" <%= filters?.location==="Cà Mau" ? "selected" : "" %>>Cà Mau</option>
                                    <option value="Cao Bằng" <%= filters?.location==="Cao Bằng" ? "selected" : "" %>>Cao Bằng</option>
                                    <option value="Đắk Lắk" <%= filters?.location==="Đắk Lắk" ? "selected" : "" %>>Đắk Lắk</option>
                                    <option value="Đắk Nông" <%= filters?.location==="Đắk Nông" ? "selected" : "" %>>Đắk Nông</option>
                                    <option value="Điện Biên" <%= filters?.location==="Điện Biên" ? "selected" : "" %>>Điện Biên</option>
                                    <option value="Đồng Nai" <%= filters?.location==="Đồng Nai" ? "selected" : "" %>>Đồng Nai</option>
                                    <option value="Đồng Tháp" <%= filters?.location==="Đồng Tháp" ? "selected" : "" %>>Đồng Tháp</option>
                                    <option value="Gia Lai" <%= filters?.location==="Gia Lai" ? "selected" : "" %>>Gia Lai</option>
                                    <option value="Hà Giang" <%= filters?.location==="Hà Giang" ? "selected" : "" %>>Hà Giang</option>
                                    <option value="Hà Nam" <%= filters?.location==="Hà Nam" ? "selected" : "" %>>Hà Nam</option>
                                    <option value="Hà Tĩnh" <%= filters?.location==="Hà Tĩnh" ? "selected" : "" %>>Hà Tĩnh</option>
                                    <option value="Hải Dương" <%= filters?.location==="Hải Dương" ? "selected" : "" %>>Hải Dương</option>
                                    <option value="Hậu Giang" <%= filters?.location==="Hậu Giang" ? "selected" : "" %>>Hậu Giang</option>
                                    <option value="Hòa Bình" <%= filters?.location==="Hòa Bình" ? "selected" : "" %>>Hòa Bình</option>
                                    <option value="Hưng Yên" <%= filters?.location==="Hưng Yên" ? "selected" : "" %>>Hưng Yên</option>
                                    <option value="Khánh Hòa" <%= filters?.location==="Khánh Hòa" ? "selected" : "" %>>Khánh Hòa</option>
                                    <option value="Kiên Giang" <%= filters?.location==="Kiên Giang" ? "selected" : "" %>>Kiên Giang</option>
                                    <option value="Kon Tum" <%= filters?.location==="Kon Tum" ? "selected" : "" %>>Kon Tum</option>
                                    <option value="Lai Châu" <%= filters?.location==="Lai Châu" ? "selected" : "" %>>Lai Châu</option>
                                    <option value="Lâm Đồng" <%= filters?.location==="Lâm Đồng" ? "selected" : "" %>>Lâm Đồng</option>
                                    <option value="Lạng Sơn" <%= filters?.location==="Lạng Sơn" ? "selected" : "" %>>Lạng Sơn</option>
                                    <option value="Lào Cai" <%= filters?.location==="Lào Cai" ? "selected" : "" %>>Lào Cai</option>
                                    <option value="Long An" <%= filters?.location==="Long An" ? "selected" : "" %>>Long An</option>
                                    <option value="Nam Định" <%= filters?.location==="Nam Định" ? "selected" : "" %>>Nam Định</option>
                                    <option value="Nghệ An" <%= filters?.location==="Nghệ An" ? "selected" : "" %>>Nghệ An</option>
                                    <option value="Ninh Bình" <%= filters?.location==="Ninh Bình" ? "selected" : "" %>>Ninh Bình</option>
                                    <option value="Ninh Thuận" <%= filters?.location==="Ninh Thuận" ? "selected" : "" %>>Ninh Thuận</option>
                                    <option value="Phú Thọ" <%= filters?.location==="Phú Thọ" ? "selected" : "" %>>Phú Thọ</option>
                                    <option value="Quảng Bình" <%= filters?.location==="Quảng Bình" ? "selected" : "" %>>Quảng Bình</option>
                                    <option value="Quảng Nam" <%= filters?.location==="Quảng Nam" ? "selected" : "" %>>Quảng Nam</option>
                                    <option value="Quảng Ngãi" <%= filters?.location==="Quảng Ngãi" ? "selected" : "" %>>Quảng Ngãi</option>
                                    <option value="Quảng Ninh" <%= filters?.location==="Quảng Ninh" ? "selected" : "" %>>Quảng Ninh</option>
                                    <option value="Quảng Trị" <%= filters?.location==="Quảng Trị" ? "selected" : "" %>>Quảng Trị</option>
                                    <option value="Sóc Trăng" <%= filters?.location==="Sóc Trăng" ? "selected" : "" %>>Sóc Trăng</option>
                                    <option value="Sơn La" <%= filters?.location==="Sơn La" ? "selected" : "" %>>Sơn La</option>
                                    <option value="Tây Ninh" <%= filters?.location==="Tây Ninh" ? "selected" : "" %>>Tây Ninh</option>
                                    <option value="Thái Bình" <%= filters?.location==="Thái Bình" ? "selected" : "" %>>Thái Bình</option>
                                    <option value="Thái Nguyên" <%= filters?.location==="Thái Nguyên" ? "selected" : "" %>>Thái Nguyên</option>
                                    <option value="Thanh Hóa" <%= filters?.location==="Thanh Hóa" ? "selected" : "" %>>Thanh Hóa</option>
                                    <option value="Thừa Thiên Huế" <%= filters?.location==="Thừa Thiên Huế" ? "selected" : "" %>>Thừa Thiên Huế</option>
                                    <option value="Tiền Giang" <%= filters?.location==="Tiền Giang" ? "selected" : "" %>>Tiền Giang</option>
                                    <option value="Trà Vinh" <%= filters?.location==="Trà Vinh" ? "selected" : "" %>>Trà Vinh</option>
                                    <option value="Tuyên Quang" <%= filters?.location==="Tuyên Quang" ? "selected" : "" %>>Tuyên Quang</option>
                                    <option value="Vĩnh Long" <%= filters?.location==="Vĩnh Long" ? "selected" : "" %>>Vĩnh Long</option>
                                    <option value="Vĩnh Phúc" <%= filters?.location==="Vĩnh Phúc" ? "selected" : "" %>>Vĩnh Phúc</option>
                                    <option value="Yên Bái" <%= filters?.location==="Yên Bái" ? "selected" : "" %>>Yên Bái</option>
                                    <option value="Đồng Tháp" <%= filters?.location==="Đồng Tháp" ? "selected" : "" %>>Đồng Tháp</option>
                                    <option value="Bình Phước" <%= filters?.location==="Bình Phước" ? "selected" : "" %>>Bình Phước</option>
                                  </select>                                  
                            </div>

                            <!-- Availability Filter -->
                            <div class="filter-group">
                                <label class="filter-label">Availability</label>
                                <select name="status" class="filter-select">
                                    <option value="">All Status</option>
                                    <option value="Available" <%= filters?.status==="Available" ? "selected" : "" %>>Available</option>
                                    <option value="Low Stock" <%= filters?.status==="Low Stock" ? "selected" : "" %>>Low Stock</option>
                                    <option value="Out of Stock" <%= filters?.status==="Out of Stock" ? "selected" : "" %>>Out of Stock</option>
                                </select>
                            </div>

                            <!-- Blood Product Filter -->
                            <div class="filter-group">
                                <label class="filter-label">Blood Product</label>
                                <select name="productType" class="filter-select">
                                    <option value="">All Products</option>
                                    <option value="Whole Blood" <%= filters?.productType==="Whole Blood" ? "selected" : "" %>>Whole Blood</option>
                                    <option value="Red Blood Cells" <%= filters?.productType==="Red Blood Cells" ? "selected" : "" %>>Red Blood Cells</option>
                                    <option value="Platelets" <%= filters?.productType==="Platelets" ? "selected" : "" %>>Platelets</option>
                                    <option value="Plasma" <%= filters?.productType==="Plasma" ? "selected" : "" %>>Plasma</option>
                                    <option value="Cryoprecipitate" <%= filters?.productType==="Cryoprecipitate" ? "selected" : "" %>>Cryoprecipitate</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="filters-actions">
                            <button type="submit" class="btn-primary">Apply Filters</button>
                            <a href="/page/bloodRecords" class="btn-ghost">Clear All</a>
                        </div>
                    </form>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <div class="results-header">
                        <h2 class="results-title">Blood Inventory Results</h2>
                        <span class="results-count">Showing 6 records</span>
                    </div>

                    <div class="blood-records-grid">
                        <% if (results && results.length > 0) { %> <%
                        results.forEach(stock => { %> <%
                        stock.inventory.forEach(item => { %>
                        <div class="blood-record-card">
                            <% 
                                function bloodTypeClass(bt) {
                                    switch (bt) {
                                    case "A+": return "type-a-positive";
                                    case "A-": return "type-a-negative";
                                    case "B+": return "type-b-positive";
                                    case "B-": return "type-b-negative";
                                    case "AB+": return "type-ab-positive";
                                    case "AB-": return "type-ab-negative";
                                    case "O+": return "type-o-positive";
                                    case "O-": return "type-o-negative";
                                    default: return "";
                                    }
                                }
                                %>

                                <div class="card-header">
                                <div class="blood-type-badge <%= bloodTypeClass(item.bloodType) %>">
                                    <%= item.bloodType %>
                                </div>

                                <div class="availability-status <%= item.status.toLowerCase().replace(/\s+/g, '-') %>">
                                    <%= item.status %>
                                </div>
                            </div>

                            <div class="card-content">
                                <h3 class="hospital-name">
                                    <%= stock.hospitalId?.name %>
                                </h3>
                                <p class="hospital-location">
                                    <%= stock.hospitalId?.city %>, <%=
                                    stock.hospitalId?.region %>
                                </p>
                                <div class="blood-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Blood Type:</span>
                                        <span class="detail-value"><%= item.bloodType %></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label"
                                            >Amount:</span
                                        >
                                        <span class="detail-value"
                                            ><%= item.quantity %> <%= item.unit
                                            %></span
                                        >
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label"
                                            >Expiry:</span
                                        >
                                        <span class="detail-value"
                                            ><%= item.expiryDate ? new
                                            Date(item.expiryDate).toDateString()
                                            : 'N/A' %></span
                                        >
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button type="button" class="btn-primary btn-request">Send Request</button>
                                    <button type="button" class="btn-ghost btn-details">Details</button>
                                </div>
                            </div>
                        </div>
                        <% }) %> <% }) %> <% } else { %>
                        <p style="color: black;">No blood stock found for selected filters.</p>
                        <% } %>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination">
                        <button class="pagination-btn" disabled>
                            Previous
                        </button>
                        <div class="pagination-numbers">
                            <button class="pagination-number active">1</button>
                            <button class="pagination-number">2</button>
                            <button class="pagination-number">3</button>
                        </div>
                        <button class="pagination-btn">Next</button>
                    </div>
                </div>
            </div>
            <script>
                // Add click handlers for Request and Details
                document.querySelectorAll(".btn-request").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const card = btn.closest(".blood-record-card");
                        const hospitalName = card.querySelector(".hospital-name").textContent;
                        alert(`Request submitted for ${hospitalName}`);
                    });
                });

                document.querySelectorAll(".btn-details").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const card = btn.closest(".blood-record-card");
                        const hospitalName = card.querySelector(".hospital-name").textContent;
                        const bloodType = card.querySelector(".blood-type-badge").textContent;
                        const amount = card.querySelector(".detail-item:nth-child(2) .detail-value").textContent;
                        const expiry = card.querySelector(".detail-item:last-child .detail-value").textContent;

                        alert(
                        `Details for ${hospitalName}:\nBlood Type: ${bloodType}\nAmount: ${amount}\nExpiry: ${expiry}`
                        );
                    });
                });

                document.addEventListener("DOMContentLoaded", () => {
                    const maxLiters = 1000; // Maximum capacity in liters for percentage calculation
                    const cards =
                        document.querySelectorAll(".blood-record-card");

                    cards.forEach((card, index) => {
                        // Find the detail item where label contains "Amount:"
                        const detailItems =
                            card.querySelectorAll(".detail-item");
                        let amountEl = null;

                        detailItems.forEach((item) => {
                            const label = item.querySelector(".detail-label");
                            if (
                                label &&
                                label.textContent
                                    .toLowerCase()
                                    .includes("amount")
                            ) {
                                amountEl = item.querySelector(".detail-value");
                            }
                        });

                        if (!amountEl) return;

                        let amountText = amountEl.textContent
                            .toLowerCase()
                            .trim();
                        let liters = 0;

                        // Parse the amount text to extract number and convert to liters
                        const numberMatch = amountText.match(/(\d+(?:\.\d+)?)/);
                        if (numberMatch) {
                            const number = parseFloat(numberMatch[1]);

                            if (
                                amountText.includes("milliliter") ||
                                amountText.includes("ml")
                            ) {
                                liters = number / 1000; // Convert milliliters to liters
                            } else if (
                                amountText.includes("liter") ||
                                amountText.includes("l")
                            ) {
                                liters = number; // Already in liters
                            }
                        }

                        // Calculate percentage (cap at 100%)
                        const percent = Math.min(
                            (liters / maxLiters) * 100,
                            100
                        );
                        const bar = card.querySelector(".blood-bar");

                        if (bar) {
                            // Add staggered delay for animation effect
                            setTimeout(() => {
                                bar.style.width = percent + "%";

                                // Add a data attribute to show the actual percentage
                                bar.setAttribute(
                                    "data-percentage",
                                    Math.round(percent) + "%"
                                );

                                // Optional: Add tooltip or percentage display
                                bar.title = `${liters.toFixed(
                                    1
                                )}L (${Math.round(percent)}% of capacity)`;
                            }, 200 + index * 100); // Staggered animation
                        }
                    });

                    // Add click handlers for buttons
                    const requestButtons =
                        document.querySelectorAll(".btn-primary");
                    const detailButtons =
                        document.querySelectorAll(".btn-ghost");

                    requestButtons.forEach((btn, index) => {
                        btn.addEventListener("click", () => {
                            const card = btn.closest(".blood-record-card");
                            const hospitalName =
                                card.querySelector(
                                    ".hospital-name"
                                ).textContent;
                            alert(`Request submitted for ${hospitalName}`);
                        });
                    });

                    detailButtons.forEach((btn, index) => {
                        btn.addEventListener("click", () => {
                            const card = btn.closest(".blood-record-card");
                            const hospitalName =
                                card.querySelector(
                                    ".hospital-name"
                                ).textContent;
                            const bloodType =
                                card.querySelector(
                                    ".blood-type-badge"
                                ).textContent;
                            const amount = card.querySelector(
                                ".detail-item:nth-child(2) .detail-value"
                            ).textContent;
                            const expiry = card.querySelector(
                                ".detail-item:last-child .detail-value"
                            ).textContent;

                            alert(
                                `Details for ${hospitalName}:\nBlood Type: ${bloodType}\nAmount: ${amount}\nExpiry: ${expiry}`
                            );
                        });
                    });
                });
            </script>
        </main>
        <!-- Footer -->
        <%- include('partials/footer.ejs') %>

        <script>
            function scrollToAbout() {
                document
                    .getElementById("about")
                    .scrollIntoView({ behavior: "smooth" });
            }
        </script>
        <script
            type="module"
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
        ></script>
        <script
            nomodule
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
        ></script>
    </body>
</html>
